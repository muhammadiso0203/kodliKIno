import { Telegraf, Context, Markup } from 'telegraf';
import { readFileSync, writeFileSync } from 'fs';
import { join } from 'path';

interface Movie {
  code: string;
  title: string;
  file_id: string;
}

const adminsPath = join('data', 'admins.json');
const moviesPath = join('data', 'movies.json');
const usersPath = join('data', 'users.json');
const requiredChannelPath = join('data', 'required_channel.json');

let requiredData = JSON.parse(readFileSync(requiredChannelPath, 'utf8'));
let users: number[] = JSON.parse(readFileSync(usersPath, 'utf-8'));
let admins: number[] = JSON.parse(readFileSync(adminsPath, 'utf8'));
let movies: Movie[] = JSON.parse(readFileSync(moviesPath, 'utf8'));

let requiredChannels: string[] = requiredData.channels || [];

function saveUsers() {
  writeFileSync(usersPath, JSON.stringify(users, null, 2), 'utf8');
}
function saveChannels() {
  writeFileSync(
    requiredChannelPath,
    JSON.stringify({ channels: requiredChannels }, null, 2),
    'utf8',
  );
}

// Admin panel sessiyalari
const addState = new Map<
  number,
  {
    step:
      | 'waiting_code'
      | 'waiting_video'
      | 'waiting_delete_code'
      | 'waiting_add_channel'
      | 'waiting_remove_channel'
      | 'waiting_broadcast_message'
      | 'waiting_new_admin'
      | 'waiting_remove_admin'
      | 'waiting_edit_code';

    code?: string;
    title?: string;
  }
>();

function saveMovies() {
  writeFileSync(moviesPath, JSON.stringify(movies, null, 2), 'utf8');
}

export function setupAdminPanel(bot: Telegraf<Context>) {
  // üîê Admin panel
  bot.command('admin', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return ctx.reply('‚ùå Siz admin emassiz.');

    return ctx.reply(
      'üõ† Admin Panel',
      Markup.inlineKeyboard([
        [
          Markup.button.callback('‚ûï Kino qo‚Äòshish', 'add_movie'),
          Markup.button.callback('üóë Kino o‚Äòchirish', 'delete_movie'),
          Markup.button.callback('üìã Kinolar ro‚Äòyxati', 'view_movies'),
        ],
        [
          Markup.button.callback('‚ûï Admin qo‚Äòshish', 'add_admin'),
          Markup.button.callback('üóë Adminni o‚Äòchirish', 'remove_admin'),
          Markup.button.callback('üìã Adminlar ro‚Äòyxati', 'list_admins'),
        ],
        [
          Markup.button.callback('‚ûï Kanal qo‚Äòshish', 'add_channel'),
          Markup.button.callback('üóë Kanal o‚Äòchirish', 'remove_channel'),
          Markup.button.callback('üìã Kanallar ro‚Äòyxati', 'list_channels'),
        ],
        [
          Markup.button.callback('‚ôªÔ∏è Kinoni tahrirlash', 'edit_movie'),
          Markup.button.callback('üìä Statistika', 'stats'),
          Markup.button.callback('üì§ Xabar yuborish', 'broadcast'),
        ],
      ]),
    );
  });

  // üîÑ Kinoni tahrirlash
  bot.action('edit_movie', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    addState.set(id, { step: 'waiting_edit_code' });
    ctx.answerCbQuery();
    ctx.reply('‚úèÔ∏è Qaysi koddagi kinoni tahrirlaysiz? Kodni kiriting.');
  });

  bot.action('list_admins', async (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    ctx.answerCbQuery();

    if (admins.length === 0) {
      return ctx.reply('üì≠ Adminlar ro‚Äòyxati bo‚Äòsh.');
    }

    const list = admins
      .map(
        (adminId, index) =>
          `${index + 1}. [Admin](tg://user?id=${adminId}) ‚Äî \`${adminId}\``,
      )
      .join('\n');

    ctx.replyWithMarkdownV2(`üë• *Adminlar ro‚Äòyxati:*\n\n${list}`, {
      parse_mode: 'MarkdownV2',
    });
  });

  bot.action('remove_admin', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    addState.set(id, { step: 'waiting_remove_admin' });
    ctx.answerCbQuery();
    ctx.reply(
      '‚ùå O‚Äòchirmoqchi bo‚Äòlgan adminning Telegram ID raqamini yuboring:',
    );
  });

  bot.action('add_admin', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    addState.set(id, { step: 'waiting_new_admin' });
    ctx.answerCbQuery();
    ctx.reply('üë§ Yangi adminning Telegram ID raqamini ni yuboring:');
  });

  bot.action('broadcast', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    addState.set(id, { step: 'waiting_broadcast_message' });
    ctx.answerCbQuery();
    ctx.reply('‚úâÔ∏è Yubormoqchi bo‚Äòlgan xabaringizni yozing:');
  });

  bot.action('list_channels', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    ctx.answerCbQuery();

    if (requiredChannels.length === 0) {
      return ctx.reply('üì≠ Hech qanday kanal belgilanmagan.');
    }

    const list = requiredChannels.map((ch, i) => `${i + 1}. ${ch}`).join('\n');
    ctx.reply(`üìã Majburiy kanallar ro‚Äòyxati:\n\n${list}`);
  });

  bot.action('add_channel', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    addState.set(id, { step: 'waiting_add_channel' });
    ctx.answerCbQuery();
    ctx.reply(
      'üì• Yangi kanalni username formatda yuboring (masalan: `@mychannel`)',
    );
  });

  bot.action('remove_channel', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    addState.set(id, { step: 'waiting_remove_channel' });

    const list =
      requiredChannels.map((ch, i) => `${i + 1}. ${ch}`).join('\n') ||
      'üì≠ Hozircha kanal yo‚Äòq.';
    ctx.answerCbQuery();
    ctx.reply(
      `üóë O‚Äòchirish uchun kanalni username sifatida yuboring:\n\n${list}`,
    );
  });

  bot.action('stats', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    ctx.answerCbQuery();

    const statsMessage =
      `üìä *Statistika*\n\n` +
      `üë• Foydalanuvchilar: *${users.length}*\n` +
      `üé¨ Kinolar: *${movies.length}*\n` +
      `üõ† Adminlar: *${admins.length}*`;

    ctx.replyWithMarkdown(statsMessage);
  });

  bot.action('view_movies', async (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    ctx.answerCbQuery();

    if (movies.length === 0) {
      return ctx.reply('üì≠ Kinolar ro‚Äòyxati bo‚Äòsh.');
    }

    // Har bir kinoni bitta qatorda chiqaramiz: KOD - Nomi
    const movieList = movies
      .map((m, i) => `${i + 1}. *${m.code}* ‚Äî ${m.title}`)
      .slice(0, 100) // Faqat birinchi 10 ta (hozircha)
      .join('\n');

    ctx.replyWithMarkdown(`üé¨ *Kinolar ro‚Äòyxati (1‚Äì100)*\n\n${movieList}`);
  });

  // üéõ Kino qo‚Äòshish tugmasi
  bot.action('add_movie', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    addState.set(id, { step: 'waiting_code' });
    ctx.answerCbQuery();
    ctx.reply(
      'üî° Iltimos, kod va kino nomini yuboring. Format:\n`KOD Kino nomi`',
      {
        parse_mode: 'Markdown',
      },
    );
  });

  bot.action('delete_movie', (ctx) => {
    const id = ctx.from?.id;
    if (!id || !admins.includes(id)) return;

    addState.set(id, { step: 'waiting_delete_code' });
    ctx.answerCbQuery();
    ctx.reply('üóë O‚Äòchirish uchun kino kodini yuboring.');
  });

  // Kod va nom
  bot.on('text', async (ctx, next) => {
    const id = ctx.from?.id;
    const state = addState.get(id || 0);

    if (state?.step === 'waiting_code') {
      const [code, ...titleParts] = ctx.message.text.trim().split(' ');
      const title = titleParts.join(' ');

      if (!code || !title) {
        return ctx.reply(
          '‚ùå Format noto‚Äòg‚Äòri. To‚Äòg‚Äòri format: `KOD Kino nomi`',
          { parse_mode: 'Markdown' },
        );
      }
      addState.set(id!, { step: 'waiting_video', code, title });
      return ctx.reply('üé• Endi kinoni video fayl sifatida yuboring.');
    }

    // üóë Kino o‚Äòchirish
    if (state?.step === 'waiting_delete_code') {
      const code = ctx.message.text.trim();
      const index = movies.findIndex((m) => m.code === code);

      if (index === -1) {
        return ctx.reply('‚ùå Bunday koddagi kino topilmadi.');
      }

      const removed = movies.splice(index, 1)[0];
      saveMovies();
      addState.delete(id!);

      return ctx.reply(
        `‚úÖ Kino o‚Äòchirildi: ${removed.title} (${removed.code})`,
      );
    }

    if (state?.step === 'waiting_add_channel') {
      const channel = ctx.message.text.trim();
      if (!channel.startsWith('@')) {
        return ctx.reply('‚ùå Noto‚Äòg‚Äòri format. Masalan: `@mychannel`');
      }

      if (requiredChannels.includes(channel)) {
        return ctx.reply('‚ö†Ô∏è Bu kanal allaqachon qo‚Äòshilgan.');
      }

      requiredChannels.push(channel);
      saveChannels();
      addState.delete(id!);
      return ctx.reply(`‚úÖ Kanal qo‚Äòshildi: ${channel}`);
    }

    if (state?.step === 'waiting_remove_channel') {
      const channel = ctx.message.text.trim();

      if (!requiredChannels.includes(channel)) {
        return ctx.reply('‚ùå Bunday kanal topilmadi.');
      }

      requiredChannels = requiredChannels.filter((ch) => ch !== channel);
      saveChannels();
      addState.delete(id!);
      return ctx.reply(`‚úÖ Kanal o‚Äòchirildi: ${channel}`);
    }

    if (state?.step === 'waiting_broadcast_message') {
      const message = ctx.message.text;
      let sent = 0;
      let failed = 0;

      for (const uid of users) {
        try {
          bot.telegram.sendMessage(uid, message);
          sent++;
        } catch (err) {
          failed++;
        }
      }

      ctx.reply(
        `‚úÖ Xabar jo‚Äònatildi: ${sent} ta\n‚ùå Yetkazib bo‚Äòlmadi: ${failed} ta`,
      );
      addState.delete(id!);
      return;
    }

    if (state?.step === 'waiting_new_admin') {
      const input = ctx.message.text.trim();

      let newAdminId: number | undefined;

      // Agar faqat raqam bo‚Äòlsa (ID bo‚Äòlishi mumkin)
      if (/^\d+$/.test(input)) {
        newAdminId = parseInt(input);
      }

      if (!newAdminId) {
        return ctx.reply('‚ùå Noto‚Äòg‚Äòri ID berildi.');
      }

      if (admins.includes(newAdminId)) {
        return ctx.reply('‚ö†Ô∏è Bu foydalanuvchi allaqachon admin.');
      }

      admins.push(newAdminId);
      writeFileSync(adminsPath, JSON.stringify(admins, null, 2), 'utf8');
      addState.delete(ctx.from.id);

      return ctx.reply(`‚úÖ Admin muvaffaqiyatli qo‚Äòshildi! ID: ${newAdminId}`);
    }

    if (state?.step === 'waiting_remove_admin') {
      const input = ctx.message.text.trim();

      if (!/^\d+$/.test(input)) {
        return ctx.reply('‚ùå Faqat raqamli Telegram ID yuboring.');
      }

      const adminId = parseInt(input);

      if (!admins.includes(adminId)) {
        return ctx.reply('‚ö†Ô∏è Bunday IDdagi admin topilmadi.');
      }

      admins = admins.filter((a) => a !== adminId);
      writeFileSync(adminsPath, JSON.stringify(admins, null, 2), 'utf8');
      addState.delete(ctx.from.id);

      return ctx.reply(`‚úÖ Admin muvaffaqiyatli o‚Äòchirildi! ID: ${adminId}`);
    }

    if (state?.step === 'waiting_edit_code') {
      const code = ctx.message.text.trim();
      const movie = movies.find((m) => m.code === code);

      if (!movie) {
        return ctx.reply('‚ùå Bunday koddagi kino topilmadi.');
      }

      addState.set(id!, {
        step: 'waiting_edit_code',
        code,
        title: movie.title,
      });
      return ctx.reply(`üé• Yangi videoni yuboring: *${movie.title}*`, {
        parse_mode: 'Markdown',
      });
    }

    return next(); // boshqa textlarga o'tkazish
  });

  // Kino videoni qabul qilish
  bot.on('video', (ctx) => {
    const id = ctx.from?.id;
    const state = addState.get(id || 0);

    // üé¨ Kino qo‚Äòshish holati
    if (state?.step === 'waiting_video' && state.code && state.title) {
      const file_id = ctx.message.video.file_id;

      movies.push({ code: state.code, title: state.title, file_id });
      saveMovies();

      addState.delete(id!);

      return ctx.reply(`‚úÖ Kino saqlandi: ${state.title} (${state.code})`);
    }

    // ‚ôªÔ∏è Kino tahrirlash holati
    if (state?.step === 'waiting_edit_code' && state.code) {
      const index = movies.findIndex((m) => m.code === state.code);
      if (index === -1) {
        return ctx.reply('‚ùå Kino topilmadi.');
      }

      // video yangilash
      movies[index].file_id = ctx.message.video.file_id;
      saveMovies();

      addState.delete(id!);

      return ctx.reply(
        `‚úÖ Kino yangilandi: ${movies[index].title} (${movies[index].code})`,
      );
    }
  });
}

export function findMovieByCode(code: string): Movie | undefined {
  return movies.find((m) => m.code === code);
}

export { users, saveUsers };
